<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SIMPLE D&D CHARACTER SHEET</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Georgia', serif;
            max-width: 100%;
            margin: 10px auto;
            padding: 10px;
            background-color: #FDF5E6; /* Parchment-like background */
            background-image: url('https://www.transparenttextures.com/patterns/paper.png');
            color: #333;
            text-transform: uppercase !important;
        }
        .section {
            margin: 10px;
            background-color: #FDF5E6; /* Light parchment */
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #8B4513; /* Stone-like brown */
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        h1, h2, h3 {
            font-family: 'Times New Roman', serif;
            color: #4B2E0B; /* Dark brown */
            margin-top: 0;
        }
        h1 {
            text-align: center;
            font-size: 24px;
        }
        h2 {
            font-size: 18px;
        }
        h3 {
            font-size: 14px;
            margin-bottom: 5px;
        }
        .section-header {
            margin-bottom: 10px;
        }
        .section-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }
        .info-toggle {
            background-color: #8B4513;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 10px;
            text-transform: uppercase;
            font-family: 'Georgia', serif;
            touch-action: manipulation;
            min-width: 24px;
            min-height: 24px;
            position: relative;
            z-index: 1;
        }
        .info-toggle:hover {
            background-color: #A0522D;
        }
        .info-content {
            display: none;
            background-color: #FDF5E6;
            border: 1px solid #8B4513;
            padding: 8px;
            margin-top: 10px;
            font-size: 12px;
            color: #4B2E0B;
            line-height: 1.4;
            text-transform: none !important;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 4px;
            border: 1px solid #8B4513;
            border-radius: 3px;
            text-transform: uppercase;
            font-family: 'Georgia', serif;
        }
        input::placeholder {
            font-size: 10px;
            text-transform: uppercase;
            color: #666;
        }
        input[type="number"] {
            width: 60px;
            display: inline-block;
        }
        button {
            background-color: #8B4513; /* Leather brown */
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            text-transform: uppercase;
            font-family: 'Georgia', serif;
            touch-action: manipulation;
            min-width: 24px;
            min-height: 24px;
            position: relative;
            z-index: 1;
        }
        button:hover {
            background-color: #A0522D; /* Lighter leather */
        }
        .remove-button {
            background-color: #A52A2A; /* Red-tinted leather */
        }
        .remove-button:hover {
            background-color: #8B0000;
        }
        .character-name {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-bottom: 10px;
        }
        .character-name input {
            width: 150px;
        }
        .character-name span {
            font-size: 14px;
            color: #4B2E0B;
        }
        .identity-section, .gear-section, .abilities-section, .conditions-section {
            margin-bottom: 15px;
        }
        .identity-section div, .gear-section, .abilities-section, .conditions-section {
            margin-bottom: 10px;
        }
        .item {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-bottom: 5px;
        }
        .item input[type="text"] {
            flex-grow: 1;
        }
        .hp-section {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
        }
        .hp-controls {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .dice-roller {
            margin-bottom: 15px;
        }
        .d20-decagon {
            background-color: #8B4513;
            color: white;
            border: none;
            border-radius: 3px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            text-transform: uppercase;
            clip-path: polygon(50% 0%, 79% 9%, 94% 35%, 94% 65%, 79% 91%, 50% 100%, 21% 91%, 6% 65%, 6% 35%, 21% 9%);
            touch-action: manipulation;
            min-width: 50px;
            min-height: 50px;
            position: relative;
            z-index: 1;
        }
        .d20-decagon:hover {
            background-color: #A0522D;
        }
        .dice-result {
            font-size: 14px;
            color: #4B2E0B;
            margin-top: 5px;
        }
        .notes textarea {
            width: 100%;
            height: 100px;
            padding: 4px;
            border: 1px solid #8B4513;
            border-radius: 3px;
            text-transform: uppercase;
            font-family: 'Georgia', serif;
        }
        .notes-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }
        .notes-footer-right {
            display: flex;
            gap: 5px;
            float: right;
        }
        .clear {
            clear: both;
        }
        @media screen and (max-width: 600px) {
            body {
                padding: 5px;
            }
            .section {
                padding: 10px;
                margin: 5px;
            }
            input[type="text"], input[type="number"] {
                padding: 3px;
                font-size: 12px;
            }
            input::placeholder {
                font-size: 8px;
            }
            input[type="number"] {
                width: 40px;
            }
            .character-name input {
                width: 120px;
            }
            .hp-section {
                gap: 10px;
            }
            .d20-decagon {
                width: 50px;
                height: 50px;
                font-size: 14px;
            }
            button {
                padding: 3px 6px;
                font-size: 10px;
            }
            .info-toggle {
                padding: 3px 6px;
                font-size: 8px;
            }
            .info-content {
                font-size: 10px;
            }
            .dice-result, .character-name span {
                font-size: 12px;
            }
            h1 {
                font-size: 20px;
            }
            h2 {
                font-size: 16px;
            }
            h3 {
                font-size: 12px;
            }
            .notes textarea {
                height: 80px;
            }
        }
    </style>
</head>
<body>
    <h1>SIMPLE D&D CHARACTER SHEET</h1>

    <div class="section character-info">
        <div class="section-header">
            <h2>CHARACTER</h2>
        </div>
        <div class="character-name">
            <input type="text" id="name" placeholder="NAME" onchange="saveCharacter()">
            <span>THE</span>
            <input type="text" id="concept" placeholder="CHARACTER CONCEPT" onchange="saveCharacter()">
        </div>
        <div class="info-content" id="character-info-info">
            Your character’s name and concept define their identity. Example: “Zavolorn the Healer” describes a healer named Zavolorn. Enter a name and a short description of their role or personality.
        </div>
        <div class="section-footer">
            <button class="info-toggle" id="info-character-info">INFO</button>
        </div>
    </div>

    <div class="section identity">
        <div class="section-header">
            <h2>IDENTITY</h2>
        </div>
        <div class="identity-section traits">
            <h3>TRAITS</h3>
            <div class="item" data-index="0">
                <input type="text" id="trait-0" placeholder="TRAIT" onchange="saveCharacter()">
                <button class="remove-button" id="remove-trait-0">-</button>
            </div>
            <button class="add-button" id="add-trait">+ ADD TRAIT</button>
        </div>
        <div class="identity-section flaws">
            <h3>FLAWS</h3>
            <div class="item" data-index="0">
                <input type="text" id="flaw-0" placeholder="FLAW" onchange="saveCharacter()">
                <button class="remove-button" id="remove-flaw-0">-</button>
            </div>
            <button class="add-button" id="add-flaw">+ ADD FLAW</button>
        </div>
        <div class="identity-section aspirations">
            <h3>ASPIRATIONS</h3>
            <div class="item" data-index="0">
                <input type="text" id="aspiration-0" placeholder="ASPIRATION" onchange="saveCharacter()">
                <button class="remove-button" id="remove-aspiration-0">-</button>
            </div>
            <button class="add-button" id="add-aspiration">+ ADD ASPIRATION</button>
        </div>
        <div class="info-content" id="identity-info">
            Traits, flaws, and aspirations shape your character’s personality and goals. Traits are positive qualities (e.g., “brave”), flaws are weaknesses (e.g., “impulsive”), and aspirations are goals (e.g., “save village”). Add at least one of each.
        </div>
        <div class="section-footer">
            <button class="info-toggle" id="info-identity">INFO</button>
        </div>
    </div>

    <div class="section hp">
        <div class="section-header">
            <h2>CONDITIONS</h2>
        </div>
        <div class="conditions-section">
            <div class="item" data-index="0">
                <input type="text" id="condition-0" placeholder="CONDITION" onchange="saveCharacter()">
                <button class="remove-button" id="remove-condition-0">-</button>
            </div>
            <button class="add-button" id="add-condition">+ ADD CONDITION</button>
        </div>
        <div class="info-content" id="hp-info">
            You track Conditions — depicting narrative harm.<br><br>
            ❌ Conditions (dynamic slots)<br>
            Represent lasting harm: injury, fatigue, fear, corruption, exposure, etc.<br>
            Take a Condition when an enemy or narrative failure warrants lasting consequences.<br><br>
            Examples: “Burned,” “Disoriented,” “Possessed,” “Shattered Hand,” “Hunted”<br><br>
            🧠 At 3 Conditions, if you are harmed again - you’re out of action (broken, dead, fled, or transformed).
        </div>
        <div class="section-footer">
            <button class="info-toggle" id="info-hp">INFO</button>
        </div>
    </div>

    <div class="section gear">
        <div class="section-header">
            <h2>GEAR</h2>
        </div>
        <div class="gear-section">
            <div class="item" data-index="0">
                <input type="text" id="gear-0" placeholder="WEAPON/TOOL/ITEM" onchange="saveCharacter()">
                <button class="remove-button" id="remove-gear-0">-</button>
            </div>
            <button class="add-button" id="add-gear">+ ADD GEAR</button>
        </div>
        <div class="info-content" id="gear-info">
            Gear includes your character’s weapons, tools, or items (e.g., “sword,” “shield”). Add items you carry or use in adventures.
        </div>
        <div class="section-footer">
            <button class="info-toggle" id="info-gear">INFO</button>
        </div>
    </div>

    <div class="section abilities">
        <div class="section-header">
            <h2>ABILITIES/FEATS</h2>
        </div>
        <div class="abilities-section">
            <div class="item" data-index="0">
                <input type="text" id="ability-0" placeholder="SPELL/ABILITY/FEATURE/SKILL" onchange="saveCharacter()">
                <button class="remove-button" id="remove-ability-0">-</button>
            </div>
            <button class="add-button" id="add-ability">+ ADD ABILITY</button>
        </div>
        <div class="info-content" id="abilities-info">
            Abilities/feats list your character’s spells, skills, or special abilities (e.g., “fireball,” “dodge”). Add at least one to define what your character can do.
        </div>
        <div class="section-footer">
            <button class="info-toggle" id="info-abilities">INFO</button>
        </div>
    </div>

    <div class="section dice-roller">
        <div class="section-header">
            <h2>DICE ROLLER (D20)</h2>
        </div>
        <button class="d20-decagon" id="d20-result">ROLL</button>
        <div class="dice-result" id="dice-message"></div>
        <div class="info-content" id="dice-roller-info">
            Roll a 20-sided die (d20) to determine the success of actions. Click the decagon to roll. A 1 is a “dire failure” (guaranteed bad outcome), and a 20 is a “great success” (guaranteed excellent outcome).
        </div>
        <div class="section-footer">
            <button class="info-toggle" id="info-dice-roller">INFO</button>
        </div>
    </div>

    <div class="section notes">
        <div class="section-header">
            <h2>NOTES</h2>
        </div>
        <textarea id="notes" placeholder="ENTER NOTES HERE" onchange="saveCharacter()"></textarea>
        <div class="notes-footer">
            <button id="save-notes">SAVE NOTES</button>
            <div class="notes-footer-right">
                <button id="export-character">EXPORT CHARACTER</button>
                <label for="import-file" style="display: inline-block;">
                    <button id="import-character">IMPORT CHARACTER</button>
                </label>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importCharacter(event)">
            </div>
            <div class="clear"></div>
        </div>
        <div class="info-content" id="notes-info">
            Use notes to record extra details, campaign events, or character backstory. Save notes to store them, and use export/import to save or load your entire character.
        </div>
        <div class="section-footer">
            <button class="info-toggle" id="info-notes">INFO</button>
        </div>
    </div>

    <script>
        let traitCount = 1;
        let flawCount = 1;
        let aspirationCount = 1;
        let gearCount = 1;
        let abilityCount = 1;
        let conditionCount = 1;

        // Helper function to add click and touchstart events
        function addEvent(element, handler, id) {
            if (!element) {
                console.error(`Element not found for ${id}`);
                return;
            }
            // Prevent duplicate events
            element.removeEventListener('click', handler);
            element.removeEventListener('touchstart', handler);
            element.addEventListener('click', (e) => {
                e.preventDefault();
                handler(e);
                console.log(`${id} clicked`);
            });
            element.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handler(e);
                console.log(`${id} touched`);
            });
        }

        function toggleInfo(sectionId) {
            try {
                const info = document.getElementById(`${sectionId}-info`);
                if (!info) throw new Error(`Info content not found for ${sectionId}`);
                info.style.display = info.style.display === 'block' ? 'none' : 'block';
                console.log(`Toggled info for ${sectionId}`);
            } catch (err) {
                console.error(`Error in toggleInfo for ${sectionId}:`, err);
            }
        }

        function updateCharacterName() {
            try {
                const name = document.getElementById('name').value;
                const concept = document.getElementById('concept').value;
                saveCharacter();
                console.log('Character name updated');
            } catch (err) {
                console.error('Error in updateCharacterName:', err);
            }
        }

        function addTrait() {
            try {
                const container = document.querySelector('.traits');
                if (!container) throw new Error('Traits container not found');
                const addButton = container.querySelector('.add-button');
                if (!addButton) throw new Error('Add Trait button not found');
                const index = traitCount++;
                const item = document.createElement('div');
                item.className = 'item';
                item.setAttribute('data-index', index);
                item.innerHTML = `
                    <input type="text" id="trait-${index}" placeholder="TRAIT" onchange="saveCharacter()">
                    <button class="remove-button" id="remove-trait-${index}">-</button>
                `;
                container.insertBefore(item, addButton);
                updateRemoveButtons('trait');
                addEvent(document.getElementById(`remove-trait-${index}`), () => removeTrait(index), `remove-trait-${index}`);
                saveCharacter();
                console.log(`Added trait-${index}`);
            } catch (err) {
                console.error('Error in addTrait:', err);
            }
        }

        function removeTrait(index) {
            try {
                if (traitCount <= 1) {
                    console.log('Cannot remove last trait; minimum one required');
                    return;
                }
                const item = document.querySelector(`.traits .item[data-index="${index}"]`);
                if (!item) throw new Error(`Trait item ${index} not found`);
                item.remove();
                traitCount--;
                updateRemoveButtons('trait');
                saveCharacter();
                console.log(`Removed trait-${index}`);
            } catch (err) {
                console.error('Error in removeTrait:', err);
            }
        }

        function addFlaw() {
            try {
                const container = document.querySelector('.flaws');
                if (!container) throw new Error('Flaws container not found');
                const addButton = container.querySelector('.add-button');
                if (!addButton) throw new Error('Add Flaw button not found');
                const index = flawCount++;
                const item = document.createElement('div');
                item.className = 'item';
                item.setAttribute('data-index', index);
                item.innerHTML = `
                    <input type="text" id="flaw-${index}" placeholder="FLAW" onchange="saveCharacter()">
                    <button class="remove-button" id="remove-flaw-${index}">-</button>
                `;
                container.insertBefore(item, addButton);
                updateRemoveButtons('flaw');
                addEvent(document.getElementById(`remove-flaw-${index}`), () => removeFlaw(index), `remove-flaw-${index}`);
                saveCharacter();
                console.log(`Added flaw-${index}`);
            } catch (err) {
                console.error('Error in addFlaw:', err);
            }
        }

        function removeFlaw(index) {
            try {
                if (flawCount <= 1) {
                    console.log('Cannot remove last flaw; minimum one required');
                    return;
                }
                const item = document.querySelector(`.flaws .item[data-index="${index}"]`);
                if (!item) throw new Error(`Flaw item ${index} not found`);
                item.remove();
                flawCount--;
                updateRemoveButtons('flaw');
                saveCharacter();
                console.log(`Removed flaw-${index}`);
            } catch (err) {
                console.error('Error in removeFlaw:', err);
            }
        }

        function addAspiration() {
            try {
                const container = document.querySelector('.aspirations');
                if (!container) throw new Error('Aspirations container not found');
                const addButton = container.querySelector('.add-button');
                if (!addButton) throw new Error('Add Aspiration button not found');
                const index = aspirationCount++;
                const item = document.createElement('div');
                item.className = 'item';
                item.setAttribute('data-index', index);
                item.innerHTML = `
                    <input type="text" id="aspiration-${index}" placeholder="ASPIRATION" onchange="saveCharacter()">
                    <button class="remove-button" id="remove-aspiration-${index}">-</button>
                `;
                container.insertBefore(item, addButton);
                updateRemoveButtons('aspiration');
                addEvent(document.getElementById(`remove-aspiration-${index}`), () => removeAspiration(index), `remove-aspiration-${index}`);
                saveCharacter();
                console.log(`Added aspiration-${index}`);
            } catch (err) {
                console.error('Error in addAspiration:', err);
            }
        }

        function removeAspiration(index) {
            try {
                if (aspirationCount <= 1) {
                    console.log('Cannot remove last aspiration; minimum one required');
                    return;
                }
                const item = document.querySelector(`.aspirations .item[data-index="${index}"]`);
                if (!item) throw new Error(`Aspiration item ${index} not found`);
                item.remove();
                aspirationCount--;
                updateRemoveButtons('aspiration');
                saveCharacter();
                console.log(`Removed aspiration-${index}`);
            } catch (err) {
                console.error('Error in removeAspiration:', err);
            }
        }

        function addGear() {
            try {
                const container = document.querySelector('.gear-section');
                if (!container) throw new Error('Gear container not found');
                const addButton = container.querySelector('.add-button');
                if (!addButton) throw new Error('Add Gear button not found');
                const index = gearCount++;
                const item = document.createElement('div');
                item.className = 'item';
                item.setAttribute('data-index', index);
                item.innerHTML = `
                    <input type="text" id="gear-${index}" placeholder="WEAPON/TOOL/ITEM" onchange="saveCharacter()">
                    <button class="remove-button" id="remove-gear-${index}">-</button>
                `;
                container.insertBefore(item, addButton);
                updateRemoveButtons('gear');
                addEvent(document.getElementById(`remove-gear-${index}`), () => removeGear(index), `remove-gear-${index}`);
                saveCharacter();
                console.log(`Added gear-${index}`);
            } catch (err) {
                console.error('Error in addGear:', err);
            }
        }

        function removeGear(index) {
            try {
                if (gearCount <= 1) {
                    console.log('Cannot remove last gear; minimum one required');
                    return;
                }
                const item = document.querySelector(`.gear-section .item[data-index="${index}"]`);
                if (!item) throw new Error(`Gear item ${index} not found`);
                item.remove();
                gearCount--;
                updateRemoveButtons('gear');
                saveCharacter();
                console.log(`Removed gear-${index}`);
            } catch (err) {
                console.error('Error in removeGear:', err);
            }
        }

        function addAbility() {
            try {
                const container = document.querySelector('.abilities-section');
                if (!container) throw new Error('Abilities container not found');
                const addButton = container.querySelector('.add-button');
                if (!addButton) throw new Error('Add Ability button not found');
                const index = abilityCount++;
                const item = document.createElement('div');
                item.className = 'item';
                item.setAttribute('data-index', index);
                item.innerHTML = `
                    <input type="text" id="ability-${index}" placeholder="SPELL/ABILITY/FEATURE/SKILL" onchange="saveCharacter()">
                    <button class="remove-button" id="remove-ability-${index}">-</button>
                `;
                container.insertBefore(item, addButton);
                updateRemoveButtons('ability');
                addEvent(document.getElementById(`remove-ability-${index}`), () => removeAbility(index), `remove-ability-${index}`);
                saveCharacter();
                console.log(`Added ability-${index}`);
            } catch (err) {
                console.error('Error in addAbility:', err);
            }
        }

        function removeAbility(index) {
            try {
                if (abilityCount <= 1) {
                    console.log('Cannot remove last ability; minimum one required');
                    return;
                }
                const item = document.querySelector(`.abilities-section .item[data-index="${index}"]`);
                if (!item) throw new Error(`Ability item ${index} not found`);
                item.remove();
                abilityCount--;
                updateRemoveButtons('ability');
                saveCharacter();
                console.log(`Removed ability-${index}`);
            } catch (err) {
                console.error('Error in removeAbility:', err);
            }
        }

        function addCondition() {
            try {
                const container = document.querySelector('.conditions-section');
                if (!container) throw new Error('Conditions container not found');
                const addButton = container.querySelector('.add-button');
                if (!addButton) throw new Error('Add Condition button not found');
                const index = conditionCount++;
                const item = document.createElement('div');
                item.className = 'item';
                item.setAttribute('data-index', index);
                item.innerHTML = `
                    <input type="text" id="condition-${index}" placeholder="CONDITION" onchange="saveCharacter()">
                    <button class="remove-button" id="remove-condition-${index}">-</button>
                `;
                container.insertBefore(item, addButton);
                updateRemoveButtons('condition');
                addEvent(document.getElementById(`remove-condition-${index}`), () => removeCondition(index), `remove-condition-${index}`);
                saveCharacter();
                console.log(`Added condition-${index}`);
            } catch (err) {
                console.error('Error in addCondition:', err);
            }
        }

        function removeCondition(index) {
            try {
                if (conditionCount <= 1) {
                    console.log('Cannot remove last condition; minimum one required');
                    return;
                }
                const item = document.querySelector(`.conditions-section .item[data-index="${index}"]`);
                if (!item) throw new Error(`Condition item ${index} not found`);
                item.remove();
                conditionCount--;
                updateRemoveButtons('condition');
                saveCharacter();
                console.log(`Removed condition-${index}`);
            } catch (err) {
                console.error('Error in removeCondition:', err);
            }
        }

        function updateRemoveButtons(type) {
            try {
                const count = type === 'trait' ? traitCount : 
                             type === 'flaw' ? flawCount : 
                             type === 'aspiration' ? aspirationCount : 
                             type === 'gear' ? gearCount : 
                             type === 'ability' ? abilityCount : 
                             conditionCount;
                const selector = type === 'trait' ? '.traits' : 
                                type === 'flaw' ? '.flaws' : 
                                type === 'aspiration' ? '.aspirations' : 
                                type === 'gear' ? '.gear-section' : 
                                type === 'ability' ? '.abilities-section' : 
                                '.conditions-section';
                const buttons = document.querySelectorAll(`${selector} .remove-button`);
                buttons.forEach(button => {
                    button.style.display = count > 1 ? 'block' : 'none';
                });
                console.log(`Updated remove buttons for ${type}, count: ${count}`);
            } catch (err) {
                console.error('Error in updateRemoveButtons:', err);
            }
        }

        function rollD20() {
            try {
                const result = Math.floor(Math.random() * 20) + 1;
                const resultButton = document.getElementById('d20-result');
                const messageDisplay = document.getElementById('dice-message');
                if (!resultButton || !messageDisplay) throw new Error('Dice elements not found');
                resultButton.textContent = result;
                messageDisplay.textContent = '';
                if (result === 1) {
                    messageDisplay.textContent = 'DIRE FAILURE!';
                } else if (result === 20) {
                    messageDisplay.textContent = 'GREAT SUCCESS!';
                }
                console.log(`Rolled: ${result}, Message: ${messageDisplay.textContent}`);
            } catch (err) {
                console.error('Error in rollD20:', err);
            }
        }

        function saveCharacter() {
            try {
                const character = {
                    name: document.getElementById('name').value,
                    concept: document.getElementById('concept').value,
                    traits: [],
                    flaws: [],
                    aspirations: [],
                    conditions: [],
                    gear: [],
                    abilities: [],
                    notes: document.getElementById('notes').value
                };
                document.querySelectorAll('.traits .item').forEach(item => {
                    const index = item.getAttribute('data-index');
                    const input = document.getElementById(`trait-${index}`);
                    if (input && input.value) character.traits.push(input.value);
                });
                document.querySelectorAll('.flaws .item').forEach(item => {
                    const index = item.getAttribute('data-index');
                    const input = document.getElementById(`flaw-${index}`);
                    if (input && input.value) character.flaws.push(input.value);
                });
                document.querySelectorAll('.aspirations .item').forEach(item => {
                    const index = item.getAttribute('data-index');
                    const input = document.getElementById(`aspiration-${index}`);
                    if (input && input.value) character.aspirations.push(input.value);
                });
                document.querySelectorAll('.conditions-section .item').forEach(item => {
                    const index = item.getAttribute('data-index');
                    const input = document.getElementById(`condition-${index}`);
                    if (input && input.value) character.conditions.push(input.value);
                });
                document.querySelectorAll('.gear-section .item').forEach(item => {
                    const index = item.getAttribute('data-index');
                    const input = document.getElementById(`gear-${index}`);
                    if (input && input.value) character.gear.push(input.value);
                });
                document.querySelectorAll('.abilities-section .item').forEach(item => {
                    const index = item.getAttribute('data-index');
                    const input = document.getElementById(`ability-${index}`);
                    if (input && input.value) character.abilities.push(input.value);
                });
                localStorage.setItem('character', JSON.stringify(character));
                console.log('Character saved:', character);
            } catch (err) {
                console.error('Error in saveCharacter:', err);
            }
        }

        function loadCharacter() {
            try {
                const savedCharacter = localStorage.getItem('character');
                if (!savedCharacter) {
                    console.log('No saved character found in localStorage');
                    return;
                }
                const character = JSON.parse(savedCharacter);
                if (!character) {
                    console.error('Invalid character data in localStorage');
                    return;
                }

                // Load name and concept
                document.getElementById('name').value = character.name || '';
                document.getElementById('concept').value = character.concept || '';
                document.getElementById('notes').value = character.notes || '';

                // Helper function to rebuild section
                function rebuildSection(containerSelector, type, items, countVar, addFunction, removeFunction, placeholder) {
                    const container = document.querySelector(containerSelector);
                    if (!container) throw new Error(`${type} container not found`);
                    container.innerHTML = `<h3>${type.toUpperCase()}</h3>`;
                    window[countVar] = 0;
                    (items || ['']).forEach((item, index) => {
                        if (item) { // Only add non-empty items
                            const div = document.createElement('div');
                            div.className = 'item';
                            div.setAttribute('data-index', index);
                            div.innerHTML = `
                                <input type="text" id="${type.toLowerCase()}-${index}" placeholder="${placeholder}" value="${item}" onchange="saveCharacter()">
                                <button class="remove-button" id="remove-${type.toLowerCase()}-${index}">-</button>
                            `;
                            container.appendChild(div);
                            addEvent(document.getElementById(`remove-${type.toLowerCase()}-${index}`), () => removeFunction(index), `remove-${type.toLowerCase()}-${index}`);
                            window[countVar] = index + 1;
                        }
                    });
                    container.innerHTML += `<button class="add-button" id="add-${type.toLowerCase()}">+ ADD ${type}</button>`;
                    addEvent(document.getElementById(`add-${type.toLowerCase()}`), addFunction, `add-${type.toLowerCase()}`);
                    updateRemoveButtons(type.toLowerCase());
                }

                // Rebuild sections
                rebuildSection('.traits', 'TRAITS', character.traits, 'traitCount', addTrait, removeTrait, 'TRAIT');
                rebuildSection('.flaws', 'FLAWS', character.flaws, 'flawCount', addFlaw, removeFlaw, 'FLAW');
                rebuildSection('.aspirations', 'ASPIRATIONS', character.aspirations, 'aspirationCount', addAspiration, removeAspiration, 'ASPIRATION');
                rebuildSection('.conditions-section', 'CONDITION', character.conditions, 'conditionCount', addCondition, removeCondition, 'CONDITION');
                rebuildSection('.gear-section', 'GEAR', character.gear, 'gearCount', addGear, removeGear, 'WEAPON/TOOL/ITEM');
                rebuildSection('.abilities-section', 'ABILITY', character.abilities, 'abilityCount', addAbility, removeAbility, 'SPELL/ABILITY/FEATURE/SKILL');

                console.log('Character loaded from localStorage:', character);
            } catch (err) {
                console.error('Error in loadCharacter:', err);
            }
        }

        function exportCharacter() {
            try {
                const character = JSON.parse(localStorage.getItem('character') || '{}');
                const json = JSON.stringify(character, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'character.json';
                a.click();
                URL.revokeObjectURL(url);
                console.log('Character exported');
            } catch (err) {
                console.error('Error in exportCharacter:', err);
            }
        }

        function importCharacter(event) {
            try {
                const file = event.target.files[0];
                if (!file) throw new Error('No file selected');
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const character = JSON.parse(e.target.result);
                        localStorage.setItem('character', JSON.stringify(character));
                        loadCharacter();
                        alert('CHARACTER IMPORTED SUCCESSFULLY!');
                        console.log('Character imported:', character);
                    } catch (err) {
                        alert('ERROR IMPORTING CHARACTER: INVALID JSON FILE.');
                        console.error('Import error:', err);
                    }
                };
                reader.readAsText(file);
                console.log('Import character initiated');
            } catch (err) {
                console.error('Error in importCharacter:', err);
            }
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Add event listeners for static buttons
                addEvent(document.getElementById('add-trait'), addTrait, 'add-trait');
                addEvent(document.getElementById('remove-trait-0'), () => removeTrait(0), 'remove-trait-0');
                addEvent(document.getElementById('add-flaw'), addFlaw, 'add-flaw');
                addEvent(document.getElementById('remove-flaw-0'), () => removeFlaw(0), 'remove-flaw-0');
                addEvent(document.getElementById('add-aspiration'), addAspiration, 'add-aspiration');
                addEvent(document.getElementById('remove-aspiration-0'), () => removeAspiration(0), 'remove-aspiration-0');
                addEvent(document.getElementById('add-gear'), addGear, 'add-gear');
                addEvent(document.getElementById('remove-gear-0'), () => removeGear(0), 'remove-gear-0');
                addEvent(document.getElementById('add-ability'), addAbility, 'add-ability');
                addEvent(document.getElementById('remove-ability-0'), () => removeAbility(0), 'remove-ability-0');
                addEvent(document.getElementById('add-condition'), addCondition, 'add-condition');
                addEvent(document.getElementById('remove-condition-0'), () => removeCondition(0), 'remove-condition-0');
                addEvent(document.getElementById('d20-result'), rollD20, 'd20-result');
                addEvent(document.getElementById('save-notes'), saveCharacter, 'save-notes');
                addEvent(document.getElementById('export-character'), exportCharacter, 'export-character');
                addEvent(document.getElementById('import-character'), () => document.getElementById('import-file').click(), 'import-character');
                addEvent(document.getElementById('info-character-info'), () => toggleInfo('character-info'), 'info-character-info');
                addEvent(document.getElementById('info-identity'), () => toggleInfo('identity'), 'info-identity');
                addEvent(document.getElementById('info-hp'), () => toggleInfo('hp'), 'info-hp');
                addEvent(document.getElementById('info-gear'), () => toggleInfo('gear'), 'info-gear');
                addEvent(document.getElementById('info-abilities'), () => toggleInfo('abilities'), 'info-abilities');
                addEvent(document.getElementById('info-dice-roller'), () => toggleInfo('dice-roller'), 'info-dice-roller');
                addEvent(document.getElementById('info-notes'), () => toggleInfo('notes'), 'info-notes');

                // Load saved character
                loadCharacter();
                console.log('DOM loaded, event listeners initialized');
            } catch (err) {
                console.error('Error in DOMContentLoaded:', err);
            }
        });
    </script>
</body>
</html>
