<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SIMPLE D&D CHARACTER SHEET</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Georgia', serif;
            max-width: 100%;
            margin: 10px auto;
            padding: 10px;
            background-color: #FDF5E6; /* Parchment-like background */
            background-image: url('https://www.transparenttextures.com/patterns/paper.png');
            color: #333;
            text-transform: uppercase !important;
        }
        .section {
            margin: 10px;
            background-color: #FDF5E6; /* Light parchment */
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #8B4513; /* Stone-like brown */
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        h1, h2, h3 {
            font-family: 'Times New Roman', serif;
            color: #4B2E0B; /* Dark brown */
            margin-top: 0;
        }
        h1 {
            text-align: center;
            font-size: 24px;
        }
        h2 {
            font-size: 18px;
        }
        h3 {
            font-size: 14px;
            margin-bottom: 5px;
        }
        .section-header {
            margin-bottom: 10px;
        }
        .section-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }
        .info-toggle {
            background-color: #8B4513;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 10px;
            text-transform: uppercase;
            font-family: 'Georgia', serif;
            touch-action: manipulation;
            min-width: 24px;
            min-height: 24px;
            position: relative;
            z-index: 1;
        }
        .info-toggle:hover {
            background-color: #A0522D;
        }
        .info-content {
            display: none;
            background-color: #FDF5E6;
            border: 1px solid #8B4513;
            padding: 8px;
            margin-top: 10px;
            font-size: 12px;
            color: #4B2E0B;
            line-height: 1.4;
            text-transform: none !important;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 4px;
            border: 1px solid #8B4513;
            border-radius: 3px;
            text-transform: uppercase;
            font-family: 'Georgia', serif;
        }
        input::placeholder {
            font-size: 10px;
            text-transform: uppercase;
            color: #666;
        }
        input[type="number"] {
            width: 60px;
            display: inline-block;
        }
        button {
            background-color: #8B4513; /* Leather brown */
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            text-transform: uppercase;
            font-family: 'Georgia', serif;
            touch-action: manipulation;
            min-width: 24px;
            min-height: 24px;
            position: relative;
            z-index: 1;
        }
        button:hover {
            background-color: #A0522D; /* Lighter leather */
        }
        .remove-button {
            background-color: #A52A2A; /* Red-tinted leather */
        }
        .remove-button:hover {
            background-color: #8B0000;
        }
        .character-name {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-bottom: 10px;
        }
        .character-name input {
            width: 150px;
        }
        .character-name span {
            font-size: 14px;
            color: #4B2E0B;
        }
        .identity-section, .gear-section, .abilities-section {
            margin-bottom: 15px;
        }
        .identity-section div, .gear-section, .abilities-section {
            margin-bottom: 10px;
        }
        .item {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-bottom: 5px;
        }
        .item input[type="text"] {
            flex-grow: 1;
        }
        .hp-section {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
        }
        .heart {
            background-color: #A52A2A; /* Red heart */
            color: white;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            clip-path: path('M30 18 C12 0, 0 24, 1.8 30 C0 48, 30 60, 30 60 C30 60, 60 48, 58.2 30 C60 24, 48 0, 30 18 Z');
        }
        .hp-controls {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .hp-controls button {
            width: 30px;
            height: 30px;
            padding: 0;
            font-size: 16px;
            line-height: 30px;
            text-align: center;
        }
        .conditions {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .conditions input {
            width: 200px;
        }
        .dice-roller {
            margin-bottom: 15px;
        }
        .d20-decagon {
            background-color: #8B4513;
            color: white;
            border: none;
            border-radius: 3px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            text-transform: uppercase;
            clip-path: polygon(50% 0%, 79% 9%, 94% 35%, 94% 65%, 79% 91%, 50% 100%, 21% 91%, 6% 65%, 6% 35%, 21% 9%);
            touch-action: manipulation;
            min-width: 50px;
            min-height: 50px;
            position: relative;
            z-index: 1;
        }
        .d20-decagon:hover {
            background-color: #A0522D;
        }
        .dice-result {
            font-size: 14px;
            color: #4B2E0B;
            margin-top: 5px;
        }
        .notes textarea {
            width: 100%;
            height: 100px;
            padding: 4px;
            border: 1px solid #8B4513;
            border-radius: 3px;
            text-transform: uppercase;
            font-family: 'Georgia', serif;
        }
        .notes-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }
        .notes-footer-right {
            display: flex;
            gap: 5px;
            float: right;
        }
        .clear {
            clear: both;
        }
        @media screen and (max-width: 600px) {
            body {
                padding: 5px;
            }
            .section {
                padding: 10px;
                margin: 5px;
            }
            input[type="text"], input[type="number"] {
                padding: 3px;
                font-size: 12px;
            }
            input::placeholder {
                font-size: 8px;
            }
            input[type="number"] {
                width: 40px;
            }
            .character-name input {
                width: 120px;
            }
            .conditions input {
                width: 150px;
            }
            .heart {
                width: 40px;
                height: 40px;
                font-size: 8px;
                clip-path: path('M20 12 C8 0, 0 16, 1.2 20 C0 32, 20 40, 20 40 C20 40, 40 32, 38.8 20 C40 16, 32 0, 20 12 Z');
            }
            .hp-section {
                gap: 10px;
            }
            .hp-controls button {
                width: 24px;
                height: 24px;
                font-size: 12px;
                line-height: 24px;
            }
            .d20-decagon {
                width: 50px;
                height: 50px;
                font-size: 14px;
            }
            button {
                padding: 3px 6px;
                font-size: 10px;
            }
            .info-toggle {
                padding: 3px 6px;
                font-size: 8px;
            }
            .info-content {
                font-size: 10px;
            }
            .dice-result, .character-name span {
                font-size: 12px;
            }
            h1 {
                font-size: 20px;
            }
            h2 {
                font-size: 16px;
            }
            h3 {
                font-size: 12px;
            }
            .notes textarea {
                height: 80px;
            }
        }
    </style>
</head>
<body>
    <h1>SIMPLE D&D CHARACTER SHEET</h1>

    <div class="section character-info">
        <div class="section-header">
            <h2>CHARACTER</h2>
        </div>
        <div class="character-name">
            <input type="text" id="name" placeholder="NAME" onchange="updateCharacterName()">
            <span>THE</span>
            <input type="text" id="concept" placeholder="CHARACTER CONCEPT" onchange="updateCharacterName()">
            <span id="full-name"></span>
        </div>
        <div class="info-content" id="character-info-info">
            Your character‚Äôs name and concept define their identity. Example: ‚ÄúZavolorn the Healer‚Äù describes a healer named Zavolorn. Enter a name and a short description of their role or personality.
        </div>
        <div class="section-footer">
            <button class="info-toggle" id="info-character-info">INFO</button>
        </div>
    </div>

    <div class="section identity">
        <div class="section-header">
            <h2>IDENTITY</h2>
        </div>
        <div class="identity-section traits">
            <h3>TRAITS</h3>
            <div class="item" data-index="0">
                <input type="text" id="trait-0" placeholder="TRAIT" onchange="saveCharacter()">
                <button class="remove-button" id="remove-trait-0">-</button>
            </div>
            <button class="add-button" id="add-trait">+ ADD TRAIT</button>
        </div>
        <div class="identity-section flaws">
            <h3>FLAWS</h3>
            <div class="item" data-index="0">
                <input type="text" id="flaw-0" placeholder="FLAW" onchange="saveCharacter()">
                <button class="remove-button" id="remove-flaw-0">-</button>
            </div>
            <button class="add-button" id="add-flaw">+ ADD FLAW</button>
        </div>
        <div class="identity-section aspirations">
            <h3>ASPIRATIONS</h3>
            <div class="item" data-index="0">
                <input type="text" id="aspiration-0" placeholder="ASPIRATION" onchange="saveCharacter()">
                <button class="remove-button" id="remove-aspiration-0">-</button>
            </div>
            <button class="add-button" id="add-aspiration">+ ADD ASPIRATION</button>
        </div>
        <div class="info-content" id="identity-info">
            Traits, flaws, and aspirations shape your character‚Äôs personality and goals. Traits are positive qualities (e.g., ‚Äúbrave‚Äù), flaws are weaknesses (e.g., ‚Äúimpulsive‚Äù), and aspirations are goals (e.g., ‚Äúsave village‚Äù). Add at least one of each.
        </div>
        <div class="section-footer">
            <button class="info-toggle" id="info-identity">INFO</button>
        </div>
    </div>

    <div class="section hp">
        <div class="section-header">
            <h2>HIT POINTS & CONDITIONS</h2>
        </div>
        <div class="hp-section">
            <div class="hp-controls">
                <div class="heart" id="hp-display">3/3</div>
                <div>
                    <button id="hp-minus">-</button>
                    <button id="hp-plus">+</button>
                </div>
            </div>
            <div class="conditions">
                <input type="text" id="condition-0" placeholder="CONDITION 1" onchange="saveCharacter()">
                <input type="text" id="condition-1" placeholder="CONDITION 2" onchange="saveCharacter()">
                <input type="text" id="condition-2" placeholder="CONDITION 3" onchange="saveCharacter()">
            </div>
        </div>
        <div class="info-content" id="hp-info">
            You track both HP and Conditions ‚Äî blending familiarity with narrative harm.<br><br>
            üîª HP: 3 points<br>
            Mobs deal HP-only damage<br><br>
            Big threats deal HP + Conditions<br><br>
            0 HP = unconscious, dying, or narratively vulnerable<br><br>
            ‚ùå Conditions (3 slots)<br>
            Represent lasting harm: injury, fatigue, fear, corruption, exposure, etc.<br>
            Take a Condition when a powerful enemy or narrative failure warrants lasting consequences.<br><br>
            Examples: ‚ÄúBurned,‚Äù ‚ÄúDisoriented,‚Äù ‚ÄúPossessed,‚Äù ‚ÄúShattered Hand,‚Äù ‚ÄúHunted‚Äù<br><br>
            üß† At 3 Conditions = you‚Äôre out of action (broken, dead, fled, or transformed).
        </div>
        <div class="section-footer">
            <button class="info-toggle" id="info-hp">INFO</button>
        </div>
    </div>

    <div class="section gear">
        <div class="section-header">
            <h2>GEAR</h2>
        </div>
        <div class="gear-section">
            <div class="item" data-index="0">
                <input type="text" id="gear-0" placeholder="WEAPON/TOOL/ITEM" onchange="saveCharacter()">
                <button class="remove-button" id="remove-gear-0">-</button>
            </div>
            <button class="add-button" id="add-gear">+ ADD GEAR</button>
        </div>
        <div class="info-content" id="gear-info">
            Gear includes your character‚Äôs weapons, tools, or items (e.g., ‚Äúsword,‚Äù ‚Äúshield‚Äù). Add items you carry or use in adventures. At least one item is required.
        </div>
        <div class="section-footer">
            <button class="info-toggle" id="info-gear">INFO</button>
        </div>
    </div>

    <div class="section abilities">
        <div class="section-header">
            <h2>ABILITIES/FEATS</h2>
        </div>
        <div class="abilities-section">
            <div class="item" data-index="0">
                <input type="text" id="ability-0" placeholder="SPELL/ABILITY/FEATURE/SKILL" onchange="saveCharacter()">
                <button class="remove-button" id="remove-ability-0">-</button>
            </div>
            <button class="add-button" id="add-ability">+ ADD ABILITY</button>
        </div>
        <div class="info-content" id="abilities-info">
            Abilities/feats list your character‚Äôs spells, skills, or special abilities (e.g., ‚Äúfireball,‚Äù ‚Äúdodge‚Äù). Add at least one to define what your character can do.
        </div>
        <div class="section-footer">
            <button class="info-toggle" id="info-abilities">INFO</button>
        </div>
    </div>

    <div class="section dice-roller">
        <div class="section-header">
            <h2>DICE ROLLER (D20)</h2>
        </div>
        <button class="d20-decagon" id="d20-result">ROLL</button>
        <div class="dice-result" id="dice-message"></div>
        <div class="info-content" id="dice-roller-info">
            Roll a 20-sided die (d20) to determine the success of actions. Click the decagon to roll. A 1 is a ‚Äúdire failure‚Äù (bad outcome), and a 20 is a ‚Äúgreat success‚Äù (excellent outcome).
        </div>
        <div class="section-footer">
            <button class="info-toggle" id="info-dice-roller">INFO</button>
        </div>
    </div>

    <div class="section notes">
        <div class="section-header">
            <h2>NOTES</h2>
        </div>
        <textarea id="notes" placeholder="ENTER NOTES HERE" onchange="saveCharacter()"></textarea>
        <div class="notes-footer">
            <button id="save-notes">SAVE NOTES</button>
            <div class="notes-footer-right">
                <button id="export-character">EXPORT CHARACTER</button>
                <label for="import-file" style="display: inline-block;">
                    <button id="import-character">IMPORT CHARACTER</button>
                </label>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importCharacter(event)">
            </div>
            <div class="clear"></div>
        </div>
        <div class="info-content" id="notes-info">
            Use notes to record extra details, campaign events, or character backstory. Save notes to store them, and use export/import to save or load your entire character.
        </div>
        <div class="section-footer">
            <button class="info-toggle" id="info-notes">INFO</button>
        </div>
    </div>

    <script>
        let traitCount = 1;
        let flawCount = 1;
        let aspirationCount = 1;
        let gearCount = 1;
        let abilityCount = 1;

        // Helper function to add click and touchstart events
        function addEvent(element, handler, id) {
            if (!element) {
                console.error(`Element not found for ${id}`);
                return;
            }
            // Prevent duplicate events
            element.removeEventListener('click', handler);
            element.removeEventListener('touchstart', handler);
            element.addEventListener('click', (e) => {
                e.preventDefault();
                handler(e);
                console.log(`${id} clicked`);
            });
            element.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handler(e);
                console.log(`${id} touched`);
            });
        }

        function toggleInfo(sectionId) {
            try {
                const info = document.getElementById(`${sectionId}-info`);
                if (!info) throw new Error(`Info content not found for ${sectionId}`);
                info.style.display = info.style.display === 'block' ? 'none' : 'block';
                console.log(`Toggled info for ${sectionId}`);
            } catch (err) {
                console.error(`Error in toggleInfo for ${sectionId}:`, err);
            }
        }

        function updateCharacterName() {
            try {
                const name = document.getElementById('name').value;
                const concept = document.getElementById('concept').value;
                const fullName = document.getElementById('full-name');
                if (!fullName) throw new Error('Full name element not found');
                fullName.textContent = name && concept ? `${name} THE ${concept}` : '';
                saveCharacter();
                console.log('Character name updated');
            } catch (err) {
                console.error('Error in updateCharacterName:', err);
            }
        }

        function addTrait() {
            try {
                const container = document.querySelector('.traits');
                if (!container) throw new Error('Traits container not found');
                const addButton = container.querySelector('.add-button');
                if (!addButton) throw new Error('Add Trait button not found');
                const index = traitCount++;
                const item = document.createElement('div');
                item.className = 'item';
                item.setAttribute('data-index', index);
                item.innerHTML = `
                    <input type="text" id="trait-${index}" placeholder="TRAIT" onchange="saveCharacter()">
                    <button class="remove-button" id="remove-trait-${index}">-</button>
                `;
                container.insertBefore(item, addButton);
                updateRemoveButtons('trait');
                addEvent(document.getElementById(`remove-trait-${index}`), () => removeTrait(index), `remove-trait-${index}`);
                saveCharacter();
                console.log(`Added trait-${index}`);
            } catch (err) {
                console.error('Error in addTrait:', err);
            }
        }

        function removeTrait(index) {
            try {
                if (traitCount <= 1) {
                    console.log('Cannot remove last trait; minimum one required');
                    return;
                }
                const item = document.querySelector(`.traits .item[data-index="${index}"]`);
                if (!item) throw new Error(`Trait item ${index} not found`);
                item.remove();
                traitCount--;
                updateRemoveButtons('trait');
                saveCharacter();
                console.log(`Removed trait-${index}`);
            } catch (err) {
                console.error('Error in removeTrait:', err);
            }
        }

        function addFlaw() {
            try {
                const container = document.querySelector('.flaws');
                if (!container) throw new Error('Flaws container not found');
                const addButton = container.querySelector('.add-button');
                if (!addButton) throw new Error('Add Flaw button not found');
                const index = flawCount++;
                const item = document.createElement('div');
                item.className = 'item';
                item.setAttribute('data-index', index);
                item.innerHTML = `
                    <input type="text" id="flaw-${index}" placeholder="FLAW" onchange="saveCharacter()">
                    <button class="remove-button" id="remove-flaw-${index}">-</button>
                `;
                container.insertBefore(item, addButton);
                updateRemoveButtons('flaw');
                addEvent(document.getElementById(`remove-flaw-${index}`), () => removeFlaw(index), `remove-flaw-${index}`);
                saveCharacter();
                console.log(`Added flaw-${index}`);
            } catch (err) {
                console.error('Error in addFlaw:', err);
            }
        }

        function removeFlaw(index) {
            try {
                if (flawCount <= 1) {
                    console.log('Cannot remove last flaw; minimum one required');
                    return;
                }
                const item = document.querySelector(`.flaws .item[data-index="${index}"]`);
                if (!item) throw new Error(`Flaw item ${index} not found`);
                item.remove();
                flawCount--;
                updateRemoveButtons('flaw');
                saveCharacter();
                console.log(`Removed flaw-${index}`);
            } catch (err) {
                console.error('Error in removeFlaw:', err);
            }
        }

        function addAspiration() {
            try {
                const container = document.querySelector('.aspirations');
                if (!container) throw new Error('Aspirations container not found');
                const addButton = container.querySelector('.add-button');
                if (!addButton) throw new Error('Add Aspiration button not found');
                const index = aspirationCount++;
                const item = document.createElement('div');
                item.className = 'item';
                item.setAttribute('data-index', index);
                item.innerHTML = `
                    <input type="text" id="aspiration-${index}" placeholder="ASPIRATION" onchange="saveCharacter()">
                    <button class="remove-button" id="remove-aspiration-${index}">-</button>
                `;
                container.insertBefore(item, addButton);
                updateRemoveButtons('aspiration');
                addEvent(document.getElementById(`remove-aspiration-${index}`), () => removeAspiration(index), `remove-aspiration-${index}`);
                saveCharacter();
                console.log(`Added aspiration-${index}`);
            } catch (err) {
                console.error('Error in addAspiration:', err);
            }
        }

        function removeAspiration(index) {
            try {
                if (aspirationCount <= 1) {
                    console.log('Cannot remove last aspiration; minimum one required');
                    return;
                }
                const item = document.querySelector(`.aspirations .item[data-index="${index}"]`);
                if (!item) throw new Error(`Aspiration item ${index} not found`);
                item.remove();
                aspirationCount--;
                updateRemoveButtons('aspiration');
                saveCharacter();
                console.log(`Removed aspiration-${index}`);
            } catch (err) {
                console.error('Error in removeAspiration:', err);
            }
        }

        function addGear() {
            try {
                const container = document.querySelector('.gear-section');
                if (!container) throw new Error('Gear container not found');
                const addButton = container.querySelector('.add-button');
                if (!addButton) throw new Error('Add Gear button not found');
                const index = gearCount++;
                const item = document.createElement('div');
                item.className = 'item';
                item.setAttribute('data-index', index);
                item.innerHTML = `
                    <input type="text" id="gear-${index}" placeholder="WEAPON/TOOL/ITEM" onchange="saveCharacter()">
                    <button class="remove-button" id="remove-gear-${index}">-</button>
                `;
                container.insertBefore(item, addButton);
                updateRemoveButtons('gear');
                addEvent(document.getElementById(`remove-gear-${index}`), () => removeGear(index), `remove-gear-${index}`);
                saveCharacter();
                console.log(`Added gear-${index}`);
            } catch (err) {
                console.error('Error in addGear:', err);
            }
        }

        function removeGear(index) {
            try {
                if (gearCount <= 1) {
                    console.log('Cannot remove last gear; minimum one required');
                    return;
                }
                const item = document.querySelector(`.gear-section .item[data-index="${index}"]`);
                if (!item) throw new Error(`Gear item ${index} not found`);
                item.remove();
                gearCount--;
                updateRemoveButtons('gear');
                saveCharacter();
                console.log(`Removed gear-${index}`);
            } catch (err) {
                console.error('Error in removeGear:', err);
            }
        }

        function addAbility() {
            try {
                const container = document.querySelector('.abilities-section');
                if (!container) throw new Error('Abilities container not found');
                const addButton = container.querySelector('.add-button');
                if (!addButton) throw new Error('Add Ability button not found');
                const index = abilityCount++;
                const item = document.createElement('div');
                item.className = 'item';
                item.setAttribute('data-index', index);
                item.innerHTML = `
                    <input type="text" id="ability-${index}" placeholder="SPELL/ABILITY/FEATURE/SKILL" onchange="saveCharacter()">
                    <button class="remove-button" id="remove-ability-${index}">-</button>
                `;
                container.insertBefore(item, addButton);
                updateRemoveButtons('ability');
                addEvent(document.getElementById(`remove-ability-${index}`), () => removeAbility(index), `remove-ability-${index}`);
                saveCharacter();
                console.log(`Added ability-${index}`);
            } catch (err) {
                console.error('Error in addAbility:', err);
            }
        }

        function removeAbility(index) {
            try {
                if (abilityCount <= 1) {
                    console.log('Cannot remove last ability; minimum one required');
                    return;
                }
                const item = document.querySelector(`.abilities-section .item[data-index="${index}"]`);
                if (!item) throw new Error(`Ability item ${index} not found`);
                item.remove();
                abilityCount--;
                updateRemoveButtons('ability');
                saveCharacter();
                console.log(`Removed ability-${index}`);
            } catch (err) {
                console.error('Error in removeAbility:', err);
            }
        }

        function updateRemoveButtons(type) {
            try {
                const count = type === 'trait' ? traitCount : type === 'flaw' ? flawCount : type === 'aspiration' ? aspirationCount : type === 'gear' ? gearCount : abilityCount;
                const selector = type === 'trait' ? '.traits' : type === 'flaw' ? '.flaws' : type === 'aspiration' ? '.aspirations' : type === 'gear' ? '.gear-section' : '.abilities-section';
                const buttons = document.querySelectorAll(`${selector} .remove-button`);
                buttons.forEach(button => {
                    button.style.display = count > 1 ? 'block' : 'none';
                });
                console.log(`Updated remove buttons for ${type}, count: ${count}`);
            } catch (err) {
                console.error('Error in updateRemoveButtons:', err);
            }
        }

        function changeHP(amount) {
            try {
                const hpDisplay = document.getElementById('hp-display');
                if (!hpDisplay) throw new Error('HP display not found');
                let hp = parseInt(hpDisplay.textContent.split('/')[0]) || 3;
                hp = Math.min(3, Math.max(0, hp + amount));
                hpDisplay.textContent = `${hp}/3`;
                saveCharacter();
                console.log(`HP changed to ${hp}/3`);
            } catch (err) {
                console.error('Error in changeHP:', err);
            }
        }

        function rollD20() {
            try {
                const result = Math.floor(Math.random() * 20) + 1;
                const resultButton = document.getElementById('d20-result');
                const messageDisplay = document.getElementById('dice-message');
                if (!resultButton || !messageDisplay) throw new Error('Dice elements not found');
                resultButton.textContent = result;
                messageDisplay.textContent = '';
                if (result === 1) {
                    messageDisplay.textContent = 'DIRE FAILURE!';
                } else if (result === 20) {
                    messageDisplay.textContent = 'GREAT SUCCESS!';
                }
                console.log(`Rolled: ${result}, Message: ${messageDisplay.textContent}`);
            } catch (err) {
                console.error('Error in rollD20:', err);
            }
        }

        function saveCharacter() {
            try {
                const character = {
                    name: document.getElementById('name').value,
                    concept: document.getElementById('concept').value,
                    traits: [],
                    flaws: [],
                    aspirations: [],
                    hp: parseInt(document.getElementById('hp-display').textContent.split('/')[0]) || 3,
                    conditions: [
                        document.getElementById('condition-0').value,
                        document.getElementById('condition-1').value,
                        document.getElementById('condition-2').value
                    ],
                    gear: [],
                    abilities: [],
                    notes: document.getElementById('notes').value
                };
                document.querySelectorAll('.traits .item').forEach(item => {
                    const index = item.getAttribute('data-index');
                    const input = document.getElementById(`trait-${index}`);
                    if (input) character.traits.push(input.value);
                });
                document.querySelectorAll('.flaws .item').forEach(item => {
                    const index = item.getAttribute('data-index');
                    const input = document.getElementById(`flaw-${index}`);
                    if (input) character.flaws.push(input.value);
                });
                document.querySelectorAll('.aspirations .item').forEach(item => {
                    const index = item.getAttribute('data-index');
                    const input = document.getElementById(`aspiration-${index}`);
                    if (input) character.aspirations.push(input.value);
                });
                document.querySelectorAll('.gear-section .item').forEach(item => {
                    const index = item.getAttribute('data-index');
                    const input = document.getElementById(`gear-${index}`);
                    if (input) character.gear.push(input.value);
                });
                document.querySelectorAll('.abilities-section .item').forEach(item => {
                    const index = item.getAttribute('data-index');
                    const input = document.getElementById(`ability-${index}`);
                    if (input) character.abilities.push(input.value);
                });
                localStorage.setItem('character', JSON.stringify(character));
                console.log('Character saved:', character);
            } catch (err) {
                console.error('Error in saveCharacter:', err);
            }
        }

        function exportCharacter() {
            try {
                const character = JSON.parse(localStorage.getItem('character') || '{}');
                const json = JSON.stringify(character, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'character.json';
                a.click();
                URL.revokeObjectURL(url);
                console.log('Character exported');
            } catch (err) {
                console.error('Error in exportCharacter:', err);
            }
        }

        function importCharacter(event) {
            try {
                const file = event.target.files[0];
                if (!file) throw new Error('No file selected');
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const character = JSON.parse(e.target.result);
                        document.getElementById('name').value = character.name || '';
                        document.getElementById('concept').value = character.concept || '';
                        updateCharacterName();
                        document.getElementById('hp-display').textContent = `${Math.min(character.hp || 3, 3)}/3`;
                        document.getElementById('condition-0').value = character.conditions?.[0] || '';
                        document.getElementById('condition-1').value = character.conditions?.[1] || '';
                        document.getElementById('condition-2').value = character.conditions?.[2] || '';
                        document.getElementById('notes').value = character.notes || '';

                        // Clear and rebuild traits
                        const traitsContainer = document.querySelector('.traits');
                        traitsContainer.innerHTML = '<h3>TRAITS</h3>';
                        traitCount = 0;
                        (character.traits || ['']).forEach((trait, index) => {
                            const item = document.createElement('div');
                            item.className = 'item';
                            item.setAttribute('data-index', index);
                            item.innerHTML = `
                                <input type="text" id="trait-${index}" placeholder="TRAIT" value="${trait}" onchange="saveCharacter()">
                                <button class="remove-button" id="remove-trait-${index}">-</button>
                            `;
                            traitsContainer.appendChild(item);
                            addEvent(document.getElementById(`remove-trait-${index}`), () => removeTrait(index), `remove-trait-${index}`);
                            traitCount = index + 1;
                        });
                        traitsContainer.innerHTML += '<button class="add-button" id="add-trait">+ ADD TRAIT</button>';
                        addEvent(document.getElementById('add-trait'), addTrait, 'add-trait');
                        updateRemoveButtons('trait');

                        // Clear and rebuild flaws
                        const flawsContainer = document.querySelector('.flaws');
                        flawsContainer.innerHTML = '<h3>FLAWS</h3>';
                        flawCount = 0;
                        (character.flaws || ['']).forEach((flaw, index) => {
                            const item = document.createElement('div');
                            item.className = 'item';
                            item.setAttribute('data-index', index);
                            item.innerHTML = `
                                <input type="text" id="flaw-${index}" placeholder="FLAW" value="${flaw}" onchange="saveCharacter()">
                                <button class="remove-button" id="remove-flaw-${index}">-</button>
                            `;
                            flawsContainer.appendChild(item);
                            addEvent(document.getElementById(`remove-flaw-${index}`), () => removeFlaw(index), `remove-flaw-${index}`);
                            flawCount = index + 1;
                        });
                        flawsContainer.innerHTML += '<button class="add-button" id="add-flaw">+ ADD FLAW</button>';
                        addEvent(document.getElementById('add-flaw'), addFlaw, 'add-flaw');
                        updateRemoveButtons('flaw');

                        // Clear and rebuild aspirations
                        const aspirationsContainer = document.querySelector('.aspirations');
                        aspirationsContainer.innerHTML = '<h3>ASPIRATIONS</h3>';
                        aspirationCount = 0;
                        (character.aspirations || ['']).forEach((aspiration, index) => {
                            const item = document.createElement('div');
                            item.className = 'item';
                            item.setAttribute('data-index', index);
                            item.innerHTML = `
                                <input type="text" id="aspiration-${index}" placeholder="ASPIRATION" value="${aspiration}" onchange="saveCharacter()">
                                <button class="remove-button" id="remove-aspiration-${index}">-</button>
                            `;
                            aspirationsContainer.appendChild(item);
                            addEvent(document.getElementById(`remove-aspiration-${index}`), () => removeAspiration(index), `remove-aspiration-${index}`);
                            aspirationCount = index + 1;
                        });
                        aspirationsContainer.innerHTML += '<button class="add-button" id="add-aspiration">+ ADD ASPIRATION</button>';
                        addEvent(document.getElementById('add-aspiration'), addAspiration, 'add-aspiration');
                        updateRemoveButtons('aspiration');

                        // Clear and rebuild gear
                        const gearContainer = document.querySelector('.gear-section');
                        gearContainer.innerHTML = '';
                        gearCount = 0;
                        (character.gear || ['']).forEach((gear, index) => {
                            const item = document.createElement('div');
                            item.className = 'item';
                            item.setAttribute('data-index', index);
                            item.innerHTML = `
                                <input type="text" id="gear-${index}" placeholder="WEAPON/TOOL/ITEM" value="${gear}" onchange="saveCharacter()">
                                <button class="remove-button" id="remove-gear-${index}">-</button>
                            `;
                            gearContainer.appendChild(item);
                            addEvent(document.getElementById(`remove-gear-${index}`), () => removeGear(index), `remove-gear-${index}`);
                            gearCount = index + 1;
                        });
                        gearContainer.innerHTML += '<button class="add-button" id="add-gear">+ ADD GEAR</button>';
                        addEvent(document.getElementById('add-gear'), addGear, 'add-gear');
                        updateRemoveButtons('gear');

                        // Clear and rebuild abilities
                        const abilitiesContainer = document.querySelector('.abilities-section');
                        abilitiesContainer.innerHTML = '';
                        abilityCount = 0;
                        (character.abilities || ['']).forEach((ability, index) => {
                            const item = document.createElement('div');
                            item.className = 'item';
                            item.setAttribute('data-index', index);
                            item.innerHTML = `
                                <input type="text" id="ability-${index}" placeholder="SPELL/ABILITY/FEATURE/SKILL" value="${ability}" onchange="saveCharacter()">
                                <button class="remove-button" id="remove-ability-${index}">-</button>
                            `;
                            abilitiesContainer.appendChild(item);
                            addEvent(document.getElementById(`remove-ability-${index}`), () => removeAbility(index), `remove-ability-${index}`);
                            abilityCount = index + 1;
                        });
                        abilitiesContainer.innerHTML += '<button class="add-button" id="add-ability">+ ADD ABILITY</button>';
                        addEvent(document.getElementById('add-ability'), addAbility, 'add-ability');
                        updateRemoveButtons('ability');

                        localStorage.setItem('character', JSON.stringify(character));
                        alert('CHARACTER IMPORTED SUCCESSFULLY!');
                        console.log('Character imported:', character);
                    } catch (err) {
                        alert('ERROR IMPORTING CHARACTER: INVALID JSON FILE.');
                        console.error('Import error:', err);
                    }
                };
                reader.readAsText(file);
                console.log('Import character initiated');
            } catch (err) {
                console.error('Error in importCharacter:', err);
            }
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Add event listeners for static buttons
                addEvent(document.getElementById('add-trait'), addTrait, 'add-trait');
                addEvent(document.getElementById('remove-trait-0'), () => removeTrait(0), 'remove-trait-0');
                addEvent(document.getElementById('add-flaw'), addFlaw, 'add-flaw');
                addEvent(document.getElementById('remove-flaw-0'), () => removeFlaw(0), 'remove-flaw-0');
                addEvent(document.getElementById('add-aspiration'), addAspiration, 'add-aspiration');
                addEvent(document.getElementById('remove-aspiration-0'), () => removeAspiration(0), 'remove-aspiration-0');
                addEvent(document.getElementById('add-gear'), addGear, 'add-gear');
                addEvent(document.getElementById('remove-gear-0'), () => removeGear(0), 'remove-gear-0');
                addEvent(document.getElementById('add-ability'), addAbility, 'add-ability');
                addEvent(document.getElementById('remove-ability-0'), () => removeAbility(0), 'remove-ability-0');
                addEvent(document.getElementById('hp-minus'), () => changeHP(-1), 'hp-minus');
                addEvent(document.getElementById('hp-plus'), () => changeHP(1), 'hp-plus');
                addEvent(document.getElementById('d20-result'), rollD20, 'd20-result');
                addEvent(document.getElementById('save-notes'), saveCharacter, 'save-notes');
                addEvent(document.getElementById('export-character'), exportCharacter, 'export-character');
                addEvent(document.getElementById('import-character'), () => document.getElementById('import-file').click(), 'import-character');
                addEvent(document.getElementById('info-character-info'), () => toggleInfo('character-info'), 'info-character-info');
                addEvent(document.getElementById('info-identity'), () => toggleInfo('identity'), 'info-identity');
                addEvent(document.getElementById('info-hp'), () => toggleInfo('hp'), 'info-hp');
                addEvent(document.getElementById('info-gear'), () => toggleInfo('gear'), 'info-gear');
                addEvent(document.getElementById('info-abilities'), () => toggleInfo('abilities'), 'info-abilities');
                addEvent(document.getElementById('info-dice-roller'), () => toggleInfo('dice-roller'), 'info-dice-roller');
                addEvent(document.getElementById('info-notes'), () => toggleInfo('notes'), 'info-notes');

                // Load saved character
                const savedCharacter = localStorage.getItem('character');
                if (savedCharacter) {
                    const character = JSON.parse(savedCharacter);
                    document.getElementById('name').value = character.name || '';
                    document.getElementById('concept').value = character.concept || '';
                    updateCharacterName();
                    document.getElementById('hp-display').textContent = `${Math.min(character.hp || 3, 3)}/3`;
                    document.getElementById('condition-0').value = character.conditions?.[0] || '';
                    document.getElementById('condition-1').value = character.conditions?.[1] || '';
                    document.getElementById('condition-2').value = character.conditions?.[2] || '';
                    document.getElementById('notes').value = character.notes || '';

                    // Load traits
                    const traitsContainer = document.querySelector('.traits');
                    traitsContainer.innerHTML = '<h3>TRAITS</h3>';
                    traitCount = 0;
                    (character.traits || ['']).forEach((trait, index) => {
                        const item = document.createElement('div');
                        item.className = 'item';
                        item.setAttribute('data-index', index);
                        item.innerHTML = `
                            <input type="text" id="trait-${index}" placeholder="TRAIT" value="${trait}" onchange="saveCharacter()">
                            <button class="remove-button" id="remove-trait-${index}">-</button>
                        `;
                        traitsContainer.appendChild(item);
                        addEvent(document.getElementById(`remove-trait-${index}`), () => removeTrait(index), `remove-trait-${index}`);
                        traitCount = index + 1;
                    });
                    traitsContainer.innerHTML += '<button class="add-button" id="add-trait">+ ADD TRAIT</button>';
                    addEvent(document.getElementById('add-trait'), addTrait, 'add-trait');
                    updateRemoveButtons('trait');

                    // Load flaws
                    const flawsContainer = document.querySelector('.flaws');
                    flawsContainer.innerHTML = '<h3>FLAWS</h3>';
                    flawCount = 0;
                    (character.flaws || ['']).forEach((flaw, index) => {
                        const item = document.createElement('div');
                        item.className = 'item';
                        item.setAttribute('data-index', index);
                        item.innerHTML = `
                            <input type="text" id="flaw-${index}" placeholder="FLAW" value="${flaw}" onchange="saveCharacter()">
                            <button class="remove-button" id="remove-flaw-${index}">-</button>
                        `;
                        flawsContainer.appendChild(item);
                        addEvent(document.getElementById(`remove-flaw-${index}`), () => removeFlaw(index), `remove-flaw-${index}`);
                        flawCount = index + 1;
                    });
                    flawsContainer.innerHTML += '<button class="add-button" id="add-flaw">+ ADD FLAW</button>';
                    addEvent(document.getElementById('add-flaw'), addFlaw, 'add-flaw');
                    updateRemoveButtons('flaw');

                    // Load aspirations
                    const aspirationsContainer = document.querySelector('.aspirations');
                    aspirationsContainer.innerHTML = '<h3>ASPIRATIONS</h3>';
                    aspirationCount = 0;
                    (character.aspirations || ['']).forEach((aspiration, index) => {
                        const item = document.createElement('div');
                        item.className = 'item';
                        item.setAttribute('data-index', index);
                        item.innerHTML = `
                            <input type="text" id="aspiration-${index}" placeholder="ASPIRATION" value="${aspiration}" onchange="saveCharacter()">
                            <button class="remove-button" id="remove-aspiration-${index}">-</button>
                        `;
                        aspirationsContainer.appendChild(item);
                        addEvent(document.getElementById(`remove-aspiration-${index}`), () => removeAspiration(index), `remove-aspiration-${index}`);
                        aspirationCount = index + 1;
                    });
                    aspirationsContainer.innerHTML += '<button class="add-button" id="add-aspiration">+ ADD ASPIRATION</button>';
                    addEvent(document.getElementById('add-aspiration'), addAspiration, 'add-aspiration');
                    updateRemoveButtons('aspiration');

                    // Load gear
                    const gearContainer = document.querySelector('.gear-section');
                    gearContainer.innerHTML = '';
                    gearCount = 0;
                    (character.gear || ['']).forEach((gear, index) => {
                        const item = document.createElement('div');
                        item.className = 'item';
                        item.setAttribute('data-index', index);
                        item.innerHTML = `
                            <input type="text" id="gear-${index}" placeholder="WEAPON/TOOL/ITEM" value="${gear}" onchange="saveCharacter()">
                            <button class="remove-button" id="remove-gear-${index}">-</button>
                        `;
                        gearContainer.appendChild(item);
                        addEvent(document.getElementById(`remove-gear-${index}`), () => removeGear(index), `remove-gear-${index}`);
                        gearCount = index + 1;
                    });
                    gearContainer.innerHTML += '<button class="add-button" id="add-gear">+ ADD GEAR</button>';
                    addEvent(document.getElementById('add-gear'), addGear, 'add-gear');
                    updateRemoveButtons('gear');

                    // Load abilities
                    const abilitiesContainer = document.querySelector('.abilities-section');
                    abilitiesContainer.innerHTML = '';
                    abilityCount = 0;
                    (character.abilities || ['']).forEach((ability, index) => {
                        const item = document.createElement('div');
                        item.className = 'item';
                        item.setAttribute('data-index', index);
                        item.innerHTML = `
                            <input type="text" id="ability-${index}" placeholder="SPELL/ABILITY/FEATURE/SKILL" value="${ability}" onchange="saveCharacter()">
                            <button class="remove-button" id="remove-ability-${index}">-</button>
                        `;
                        abilitiesContainer.appendChild(item);
                        addEvent(document.getElementById(`remove-ability-${index}`), () => removeAbility(index), `remove-ability-${index}`);
                        abilityCount = index + 1;
                    });
                    abilitiesContainer.innerHTML += '<button class="add-button" id="add-ability">+ ADD ABILITY</button>';
                    addEvent(document.getElementById('add-ability'), addAbility, 'add-ability');
                    updateRemoveButtons('ability');
                    console.log('Character loaded from localStorage');
                }
                console.log('DOM loaded, event listeners initialized');
            } catch (err) {
                console.error('Error in DOMContentLoaded:', err);
            }
        });
    </script>
</body>
</html>
